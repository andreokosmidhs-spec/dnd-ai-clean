# Quest/Mission System Architecture Report

**Date:** 2025-11-24  
**Status:** Read-Only Analysis  
**Purpose:** Document current quest/mission implementation for future multi-hook narrative redesign

---

## 1. Overview

### Does a Quest/Mission System Exist?
**YES** - A basic quest system exists with the following characteristics:

- **Purpose:** Track player objectives and provide narrative goals
- **Scope:** Quests can be active, completed, or failed
- **Integration:** Quests are part of world_state and managed by quest_service
- **Generation:** Quests are NOT automatically generated by the DM/LLM - they must be explicitly created

### Key Finding
⚠️ **CRITICAL GAP:** The quest system exists as data structures and tracking, but there is **NO automated quest generation from the DM** during gameplay. The DM response can include `quest_updates` in the response payload, but the actual quest content must be manually constructed - it's not generated from narrative hooks or tavern scenes.

---

## 2. Backend Quest Model & Storage

### Data Model

**File:** `/app/backend/models/game_models.py`

```python
class QuestObjective(BaseModel):
    text: str
    completed: bool = False

class Quest(BaseModel):
    id: str
    title: str
    description: str
    objectives: List[QuestObjective] = Field(default_factory=list)
    status: str = "active"  # active, completed, failed
    quest_giver: Optional[str] = None
    location: Optional[str] = None
    reward_xp: int = 0
    reward_gold: int = 0
```

### Storage Location
- **Database:** MongoDB
- **Collection:** `world_states`
- **Path:** Quests are stored in `world_state.quests[]` array
- **Document Structure:**
  ```json
  {
    "campaign_id": "...",
    "world_state": {
      "current_location": "...",
      "quests": [
        {
          "id": "quest-uuid",
          "title": "Find the Lost Artifact",
          "description": "...",
          "objectives": [...],
          "status": "active",
          "quest_giver": "Elder Marcus",
          "location": "Ironforge",
          "reward_xp": 100,
          "reward_gold": 50
        }
      ],
      "active_npcs": [...],
      ...
    }
  }
  ```

### Relationships
- **Campaign:** Each quest belongs to a campaign's world_state
- **Character:** No direct link (quests are world-level, not character-specific)
- **Location:** Optional string reference to where quest was received
- **NPCs:** Optional quest_giver reference (string name, not ID)
- **World Blueprint:** No formal relationship (quests don't reference blueprint)

---

## 3. Quest Creation Pipeline

### Current Flow (Manual/Reactive)

```
[DM Action Response] 
    → [quest_updates in response]
    → [quest_service.add_quest()]
    → [MongoDB world_state.quests.push()]
    → [No frontend refresh - requires reload]
```

### Step-by-Step Breakdown

**Step 1: DM Response Parsing**
- **File:** `/app/backend/routers/dungeon_forge.py` (lines 1798-1820)
- **Trigger:** After `run_dungeon_forge()` returns a response
- **Logic:**
  ```python
  quest_updates = dm_response.get("quest_updates", {})
  if quest_updates and any([
      quest_updates.get("new_quests"),
      quest_updates.get("updated_quests"),
      quest_updates.get("completed_quest_ids")
  ]):
      # Process quest updates...
  ```

**Step 2: Add New Quests**
- **File:** `/app/backend/services/quest_service.py`
- **Function:** `add_quest(current_world, quest_data)`
- **Logic:**
  ```python
  quest_id = str(uuid.uuid4())
  quest = {
      "id": quest_id,
      "title": quest_data["title"],
      "description": quest_data["description"],
      "objectives": quest_data.get("objectives", []),
      "status": "active",
      "quest_giver": quest_data.get("quest_giver"),
      "location": quest_data.get("location"),
      "reward_xp": quest_data.get("reward_xp", 0),
      "reward_gold": quest_data.get("reward_gold", 0)
  }
  
  if "quests" not in current_world:
      current_world["quests"] = []
  current_world["quests"].append(quest)
  return quest_id
  ```

**Step 3: Complete Quests**
- **File:** `/app/backend/services/quest_service.py`
- **Function:** `complete_quest(current_world, quest_id)`
- **Returns:** XP reward
- **Updates:** Sets `quest.status = "completed"`

**Step 4: Database Write**
- **File:** `/app/backend/routers/dungeon_forge.py`
- **Function:** `update_world_state(campaign_id, updated_state)`
- **Database Call:** `db.world_states.update_one()`

### LLM Involvement

**Quest Generation:** ❌ **NOT AUTOMATED**

The DM (run_dungeon_forge function) does NOT automatically generate quests. The prompt (`build_a_version_dm_prompt`) does NOT include instructions to create quests based on:
- Tavern scenes
- NPC interactions
- World blueprint hooks
- Player backstory

**Expected Quest Format in DM Response:**
```json
{
  "narration": "...",
  "options": [...],
  "quest_updates": {
    "new_quests": [
      {
        "title": "Find the Lost Sword",
        "description": "The blacksmith needs his family heirloom",
        "objectives": [
          {"text": "Search the old ruins", "completed": false}
        ],
        "quest_giver": "Blacksmith Thoran",
        "location": "Ironforge",
        "reward_xp": 100,
        "reward_gold": 50
      }
    ],
    "completed_quest_ids": ["quest-123"]
  }
}
```

### Validation & Rules

**No Explicit Validation:**
- ❌ No max quests per campaign
- ❌ No difficulty tier validation
- ❌ No coherence checks with world intro
- ❌ No faction alignment checks
- ❌ No duplicate quest detection

**Implicit Rules:**
- Quest IDs must be unique (UUID generation)
- Status must be "active", "completed", or "failed"
- XP/gold rewards are integers (no validation of sensible ranges)

---

## 4. APIs / Endpoints

### Quest-Related Endpoints

**None.** There are NO dedicated quest endpoints. Quests are accessed indirectly through campaign/world state.

### Relevant Endpoints

**1. Get Latest Campaign**
- **Method:** `GET`
- **Path:** `/api/campaigns/latest`
- **Response Shape:**
  ```json
  {
    "success": true,
    "data": {
      "campaign_id": "...",
      "world_state": {
        "quests": [...]
      }
    },
    "error": null
  }
  ```

**2. Process Action**
- **Method:** `POST`
- **Path:** `/api/rpg_dm/action`
- **Request:**
  ```json
  {
    "campaign_id": "...",
    "character_id": "...",
    "action": "I ask the innkeeper about work"
  }
  ```
- **Response:**
  ```json
  {
    "success": true,
    "data": {
      "narration": "...",
      "options": [...],
      "world_state_update": {
        "quests": [...]  // Updated quest array (if quest_updates present)
      }
    },
    "error": null
  }
  ```

### Missing Endpoints
- ❌ `GET /api/quests` - List all quests
- ❌ `POST /api/quests` - Create a quest
- ❌ `PUT /api/quests/{id}` - Update a quest
- ❌ `DELETE /api/quests/{id}` - Delete a quest
- ❌ `POST /api/quests/{id}/complete` - Complete a quest
- ❌ `POST /api/quests/{id}/abandon` - Abandon a quest

---

## 5. Frontend Usage

### Data Fetching

**No Dedicated Quest Hooks**

Quests are fetched as part of campaign/world state:
- **Hook:** `useLatestCampaign()` (from `/app/frontend/src/hooks/useCampaigns.js`)
- **Endpoint Called:** `/api/campaigns/latest`
- **Data Path:** `response.data.world_state.quests`

**Quest Data Flow:**
```
[useLatestCampaign hook]
  → [GET /api/campaigns/latest]
  → [ApiResponse<CampaignLatestResponse>]
  → [response.data.world_state.quests]
  → [QuestLogPanel component]
```

### Components & Screens

**Primary Quest UI:**
- **Component:** `/app/frontend/src/components/QuestLogPanel.jsx`
- **Location:** Right sidebar in adventure screen
- **What User Sees:**
  - Quest title
  - Quest description
  - Objectives list with checkboxes
  - Quest giver name
  - XP and gold rewards
  - Status badge (Active/Completed/Failed)

**Display Logic:**
```jsx
<QuestLogPanel quests={worldState.quests || []} />

// Inside QuestLogPanel:
{quests.filter(q => q.status === 'active').map(quest => (
  <QuestCard
    title={quest.title}
    description={quest.description}
    objectives={quest.objectives}
    rewards={`${quest.reward_xp} XP, ${quest.reward_gold} gold`}
  />
))}
```

### User Interactions

**Available Actions:**
- ✅ **View:** User can see active quests in the quest log
- ✅ **Track:** Objectives show completion status
- ❌ **Accept:** No UI to accept quests (auto-accepted via DM response)
- ❌ **Complete:** No manual complete button (auto-completed via DM response)
- ❌ **Abandon:** No abandon functionality

**Limitations:**
- Quests appear in the quest log after world_state updates
- No real-time updates (requires game state refresh)
- No quest preview before acceptance
- No quest journal/history view
- No filtering/sorting options

---

## 6. Integration with World Intro / DM

### Current State: DISCONNECTED

**World Intro Generation:**
- **File:** `/app/backend/routers/dungeon_forge.py` (character creation)
- **Function:** Generates cinematic intro with `format_intro_for_frontend()`
- **Content:** 5-section intro describing starting location and situation
- **Quest Inclusion:** ❌ **NONE** - Intro does not mention or create quests

**DM Action Resolution:**
- **File:** `/app/backend/routers/dungeon_forge.py` (`run_dungeon_forge`)
- **Prompt:** A-Version DM prompt via `build_a_version_dm_prompt()`
- **Quest Instructions:** ❌ **NONE** - Prompt does not instruct DM to generate quests

**Missing Connections:**
1. **Intro → Quests:** Cinematic intro does NOT plant quest seeds
2. **Tavern Scene → Quests:** No special handling for tavern/inn locations
3. **NPC Dialogue → Quests:** NPCs can't dynamically offer quests
4. **World Blueprint → Quests:** Factions, threats, regions don't auto-generate quests
5. **Player Backstory → Quests:** Character background/goal doesn't create personal quests

### What COULD Work (But Doesn't)

**Scenario:** Player enters a tavern

**Current Flow:**
```
Player: "I enter the tavern"
  → DM: "You enter a warm, bustling tavern..."
  → Options: ["Order a drink", "Talk to patrons", "Find a seat"]
  → NO QUESTS OFFERED
```

**Desired Flow (Not Implemented):**
```
Player: "I enter the tavern"
  → DM: "You enter a warm tavern. You notice:
         - A merchant arguing about stolen goods
         - A town guard pinning a bounty notice
         - An old woman whispering about ruins"
  → Options: [Multiple hooks, each could become a quest]
  → quest_updates: { "new_quests": [...] }
```

---

## 7. Limitations / Gaps

### Critical Gaps for Multi-Hook Redesign

**1. No Automated Quest Generation**
- **Impact:** HIGH
- **Issue:** DM doesn't generate quests automatically from narrative
- **Needed:** Prompt instructions to detect and create quest opportunities
- **Example:** Tavern scene should spawn 2-3 quest hooks automatically

**2. No Multi-Hook Scene Support**
- **Impact:** HIGH
- **Issue:** Intro generates ONE narrative, not multiple paths
- **Needed:** "Choose your hook" moment like Slay the Spire branching
- **Example:** After intro, show 3 quest cards: "Investigate ruins", "Help merchant", "Join guard patrol"

**3. No Quest Preview/Selection**
- **Impact:** MEDIUM
- **Issue:** Quests auto-appear in quest log without player choice
- **Needed:** Quest acceptance UI (accept/decline decision)
- **Example:** NPC offers quest → Show quest card → Player clicks Accept/Decline

**4. No Quest Context in World Blueprint**
- **Impact:** MEDIUM
- **Issue:** World blueprint defines factions/threats but doesn't generate quests from them
- **Needed:** Blueprint → Quest seed mapping
- **Example:** "Orc Horde threat" → Auto-generate "Scout orc camps" quest

**5. No Narrative Coherence**
- **Impact:** MEDIUM
- **Issue:** Quests feel disconnected from intro and DM narrative
- **Needed:** Quest text should reference intro hooks, NPCs mentioned, locations described
- **Example:** If intro mentions "missing daughter", quest appears for "Find the mayor's daughter"

**6. No Quest Progression/Chaining**
- **Impact:** LOW-MEDIUM
- **Issue:** All quests are standalone, no chains or dependencies
- **Needed:** Quest A completion unlocks Quest B
- **Example:** "Deliver message" → unlocks → "Investigate the cult"

**7. No Quest Sourcing**
- **Impact:** LOW
- **Issue:** All quests are generic, no differentiation by source
- **Needed:** Quest types: Tavern notice, NPC request, Faction mission, Personal goal
- **Example:** Filter quests by "Main Story", "Side Quests", "Bounties"

**8. No Dynamic Quest Updates**
- **Impact:** LOW
- **Issue:** Quest objectives are static, can't evolve based on actions
- **Needed:** Objectives can change (e.g., "Find 3 witnesses" → "Investigate the warehouse")
- **Example:** Player discovers new info → Quest updates dynamically

---

## 8. Technical Debt

### Database Schema
- ✅ Quest model exists and is functional
- ❌ No indexes on quest_id or status for efficient queries
- ❌ No quest history (can't see failed/abandoned quests over time)
- ❌ No quest metadata (tags, difficulty, estimated duration)

### Backend Logic
- ✅ Quest CRUD operations work
- ❌ No quest validation service
- ❌ No quest recommendation engine
- ❌ No quest balancing (XP/gold rewards are arbitrary)
- ❌ No quest templates or generators

### Frontend
- ✅ Quest display component exists
- ❌ No quest acceptance flow
- ❌ No quest details modal
- ❌ No quest tracking on map
- ❌ No quest notifications
- ❌ No quest filtering/search

### AI/LLM
- ❌ No quest generation prompt
- ❌ No quest validation prompt
- ❌ No quest coherence checking
- ❌ No quest hook detection in narrative

---

## 9. Recommended Redesign Path (Future Work)

### Phase 1: Quest Generation from Intro
1. Update `format_intro_for_frontend()` to include quest seeds
2. Add quest generation to DM prompt for tavern/inn scenes
3. Create quest template system (bounties, investigations, escorts, etc.)

### Phase 2: Multi-Hook Branching
1. Generate 3 quest options after intro (like Slay the Spire)
2. Add quest preview cards with descriptions
3. Implement quest acceptance/decline UI
4. Track which hooks player chose (affects world state)

### Phase 3: Quest-NPC-Location Integration
1. Link quests to specific NPCs and locations
2. Quest givers appear in active_npcs when quest is active
3. Quest locations highlighted on map (if map exists)
4. Quest dialogue with NPCs

### Phase 4: Quest Progression
1. Implement quest chains (prerequisites)
2. Add quest stages (multi-part quests)
3. Dynamic objective updates based on discoveries
4. Faction reputation affects available quests

### Phase 5: Polish
1. Quest journal UI improvements
2. Quest notifications (toast on new quest)
3. Quest rewards preview
4. Quest completion celebrations

---

## 10. File Reference

### Backend Files
- **Models:** `/app/backend/models/game_models.py` (Quest, QuestObjective)
- **Service:** `/app/backend/services/quest_service.py` (add_quest, complete_quest)
- **Router:** `/app/backend/routers/dungeon_forge.py` (quest_updates processing)
- **Prompt:** `/app/backend/routers/dungeon_forge.py` (build_a_version_dm_prompt)

### Frontend Files
- **Component:** `/app/frontend/src/components/QuestLogPanel.jsx`
- **Hooks:** `/app/frontend/src/hooks/useCampaigns.js` (indirect quest access)
- **Contracts:** `/app/frontend/src/contracts/api.js` (ApiResponse types)

### Meta Files
- **Architecture:** `/app/meta/architecture.json` (system overview)
- **This Document:** `/app/meta/MISSIONS_ARCHITECTURE.md`

---

## 11. Summary

**Quest System Status:** ✅ EXISTS (Basic Implementation)

**What Works:**
- Data model is solid
- Storage in world_state works
- Quest tracking and completion works
- Frontend display works

**What's Missing:**
- ❌ Automated quest generation from narrative
- ❌ Multi-hook branching (Slay the Spire style)
- ❌ Quest-intro coherence
- ❌ Quest acceptance/decline flow
- ❌ Quest sourcing (tavern, NPC, faction)
- ❌ Quest chains/progression
- ❌ Dynamic quest updates

**Biggest Gap for Multi-Hook Redesign:**
The DM does NOT generate quests automatically from narrative context. The intro system and DM action system operate independently of quest creation. To implement multi-hook narratives, the DM prompt must be enhanced to:
1. Detect quest opportunities (tavern scenes, NPC mentions, threats)
2. Generate 2-3 quest options from each narrative hook
3. Include quest creation in DM response structure
4. Link quests to intro narrative and world blueprint

---

**Report Complete:** 2025-11-24  
**Next Action:** Redesign quest generation to support multi-hook narrative branching
